{% extends 'base.html' %}

{% block content %}
<!-- Герой секция -->
<section class="hero">
    <div class="hero-content">
        <p class="hero-tagline">Юридическое агентство</p>
        <h1 class="display-1 mb-3">LEXy</h1>
        <p class="hero-subtitle mb-5">
            Попали в ДТП или другую юридическую ситуацию? Опишите проблему — наш ИИ-ассистент
            проанализирует ситуацию по законам РФ и подберет проверенного юриста.
        </p>

        <div class="btn-group">
            <a href="#help" class="btn btn-primary btn-large">
                <i class="bi bi-shield-check me-2"></i>Получить помощь
            </a>
            <a href="#how-it-works" class="btn btn-outline btn-large">
                <i class="bi bi-play-circle me-2"></i>Как это работает
            </a>
        </div>
    </div>
</section>

<!-- Форма помощи -->
<section id="help" class="help-section">
    <div class="help-container">
        <h2 class="section-title">Опишите вашу ситуацию</h2>
        <p class="lead text-center mb-5">
            Не нужно регистрироваться. Просто расскажите, что случилось.
        </p>

        <div class="help-form">
            <form id="emergencyForm" method="POST" action="{% url 'submit_request' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="problemText" class="form-label">Что произошло?</label>
                    <textarea
                        id="problemText"
                        name="problem_text"
                        class="form-control"
                        placeholder="Например: 'Попал в ДТП, виновник скрылся с места аварии', 'Мне угрожают увольнением без выплаты зарплаты', 'Соседи затопили мою квартиру'..."
                        required
                        minlength="20"
                        rows="5"
                    ></textarea>
                    <div id="charCounter" class="form-note"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                        <i class="bi bi-robot me-2"></i>Проанализировать ситуацию
                    </button>
                    <p class="form-note">
                        Нажимая кнопку, вы соглашаетесь с обработкой данных
                    </p>
                </div>
            </form>

            <!-- Убрал блок formSuccess, теперь сразу редирект -->
        </div>
    </div>
</section>

<!-- Как это работает -->
<section id="how-it-works" class="how-it-works">
    <div class="container">
        <h2 class="section-title">Как это работает</h2>

        <div class="steps-grid">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3 class="step-title">Опишите проблему</h3>
                <p class="step-description">
                    Просто напишите, что случилось. Никаких сложных форм и регистрации.
                    Чем подробнее описание, тем точнее анализ.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">2</div>
                <h3 class="step-title">Анализ ИИ</h3>
                <p class="step-description">
                    Наш ИИ-ассистент анализирует ситуацию по законам РФ, определяет
                    категорию дела и готовит пошаговый план действий.
                </p>
            </div>

            <div class="step-card">
                <div class="step-number">3</div>
                <h3 class="step-title">Подбор юриста</h3>
                <p class="step-description">
                    Система находит проверенных юристов, которые специализируются
                    именно на вашей категории дел. Вы сами решаете, с кем связаться.
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Юристы (заглушка) -->
<section id="lawyers" class="help-section">
    <div class="container">
        <h2 class="section-title">Наши юристы</h2>
        <p class="lead text-center mb-5">
            Более 500 проверенных специалистов по всем отраслям права
        </p>

        <div class="text-center">
            <a href="{% url 'all_lawyers' %}" class="btn btn-outline btn-large">
                <i class="bi bi-people me-2"></i>Посмотреть всех юристов
            </a>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('emergencyForm');
    const problemText = document.getElementById('problemText');
    const charCounter = document.getElementById('charCounter');
    const submitBtn = document.getElementById('submitBtn');

    // Счетчик символов
    problemText.addEventListener('input', function() {
        const length = this.value.trim().length;
        charCounter.textContent = `${length} символов`;

        if (length < 20) {
            charCounter.style.color = '#ef4444';
        } else if (length < 100) {
            charCounter.style.color = '#f59e0b';
        } else {
            charCounter.style.color = '#10b981';
        }
    });

    // Обработка формы с автоматическим редиректом
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (problemText.value.trim().length < 20) {
            alert('Опишите проблему подробнее (минимум 20 символов)');
            problemText.focus();
            return;
        }

        const originalText = submitBtn.innerHTML;

        // Показываем загрузку
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Анализируем...';
        submitBtn.disabled = true;

        // Добавляем класс загрузки
        submitBtn.classList.add('loading');

        try {
            // Отправляем запрос
            const response = await fetch('{% url "submit_request" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    problem_text: problemText.value.trim()
                })
            });

            const data = await response.json();

            if (data.success) {
                // НЕ показываем успех, а сразу редиректим
                window.location.href = data.redirect_url;
            } else {
                // Показываем ошибку
                showError(data.error || 'Произошла ошибка. Попробуйте снова.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }

        } catch (error) {
            console.error('Error:', error);
            showError('Ошибка соединения. Проверьте интернет и попробуйте снова.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            submitBtn.classList.remove('loading');
        }
    });

    // Функция показа ошибки
    function showError(message) {
        // Создаем красивый alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'error-alert';
        alertDiv.innerHTML = `
            <div style="
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                border-radius: var(--radius-md);
                padding: 1rem 1.5rem;
                margin-top: 1rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                color: #ef4444;
            ">
                <i class="bi bi-exclamation-circle"></i>
                <span>${message}</span>
            </div>
        `;

        // Вставляем после формы
        form.parentNode.insertBefore(alertDiv, form.nextSibling);

        // Удаляем через 5 секунд
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Плавная прокрутка к форме
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            if (this.getAttribute('href') === '#') return;

            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Добавляем стиль для кнопки загрузки
const style = document.createElement('style');
style.textContent = `
    .btn.loading {
        position: relative;
        pointer-events: none;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>

<style>
/* Дополнительные стили для улучшения UX */
.error-alert {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Плавный скролл */
html {
    scroll-behavior: smooth;
}

/* Улучшаем фокус на текстовом поле */
.form-control:focus {
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
}
</style>
{% endblock %}